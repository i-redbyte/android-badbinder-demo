# Makefile для эксплойта CVE-2019-2215
# Требует установки переменной окружения $ANDROID_NDK_HOME,
# указывающей на базовый путь к Android NDK

UNAME_S := $(shell uname -s)

ifeq ($(UNAME_S),Darwin)
    HOST_TAG := darwin-x86_64
else ifeq ($(UNAME_S),Linux)
    HOST_TAG := linux-x86_64
else
    $(error Unsupported host-OS: $(UNAME_S))
endif

TARGET		= x86_64-linux-android
ANDROID_API	?= 21
PREFIX      = $(ANDROID_NDK_HOME)/toolchains/llvm/prebuilt/$(HOST_TAG)

CFLAGS		= -O3 -Wall -Wextra -pedantic -Wformat -Werror=format-security -std=gnu11
CC		    = $(PREFIX)/bin/$(TARGET)$(ANDROID_API)-clang
STRIP		= $(PREFIX)/bin/$(TARGET)-strip

SRCS        = exploit.c
OBJS		= exploit.o
TARGET_EXE  = exploit

.PHONY: all clean debug debug-static static strip

all: clean $(TARGET_EXE) strip

%.o: %.c
	$(CC) -c -o $@ $< $(CFLAGS)

$(TARGET_EXE): $(OBJS)
	$(CC) -o $@ $^ $(CFLAGS)

debug: CFLAGS := $(filter-out -O3,$(CFLAGS)) -g
debug: clean $(TARGET_EXE)

debug-static: CFLAGS := $(filter-out -O3,$(CFLAGS)) -g -static
debug-static: clean $(TARGET_EXE)

static: CFLAGS += -static
static: all

clean:
	rm -f $(TARGET_EXE) $(OBJS)

strip: $(TARGET_EXE)
	$(STRIP) $(TARGET_EXE)
