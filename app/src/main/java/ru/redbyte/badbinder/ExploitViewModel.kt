package ru.redbyte.badbinder

import androidx.lifecycle.ViewModel
import androidx.lifecycle.viewModelScope
import kotlinx.coroutines.flow.*
import kotlinx.coroutines.launch

enum class ExploitStatus {
    Idle, Running, Success, Failure
}

class ExploitViewModel : ViewModel(), NativeLogger {

    private val _logs = MutableStateFlow<List<String>>(emptyList())
    val logs: StateFlow<List<String>> = _logs.asStateFlow()

    private val _status = MutableStateFlow(ExploitStatus.Idle)
    val status: StateFlow<ExploitStatus> = _status.asStateFlow()

    private val _resultMessage = MutableStateFlow<String?>(null)
    val resultMessage: StateFlow<String?> = _resultMessage.asStateFlow()

    override fun onLog(message: String) {
        val normalized = message.replace("\t", "        ")
        viewModelScope.launch {
            _logs.update { it + normalized }
        }
    }

    fun onStart() {
        _logs.value = emptyList()
        _resultMessage.value = null
        _status.value = ExploitStatus.Running
    }

    fun onFinished(result: String) {
        _resultMessage.value = result
        _status.value = if (result.contains("successful", ignoreCase = true)
            || result.contains("root", ignoreCase = true)
        ) {
            ExploitStatus.Success
        } else {
            ExploitStatus.Failure
        }
    }

    fun reset() {
        _logs.value = emptyList()
        _resultMessage.value = null
        _status.value = ExploitStatus.Idle
    }
}
